<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
  <title>Housing Prices Narative Visualization</title>
  <!-- <script src="js/d3.min.js"></script>
  <script src="js/d3-annotation.min.js"></script> -->
  <style>
     rect {
      pointer-events: all;
      fill-opacity: 0;
      stroke-opacity: 0;
      z-index: 1;
    }

    .tooltip {
      position: absolute;
      padding: 10px;
      background-color: steelblue;
      color: white;
      border: 1px solid white;
      border-radius: 10px;
      display: none;
      opacity: .75;
    }
  </style>
</head>

<body onload="init()">
  <div class="container">
    <div class="container jumbotron banner">
      <div class="header">
        <a style="color:black" href="./">
          <h1>The Effect of the Economy by State On Housing Prices</h1>
        </a>
        <p>Narrative Visualization by Edward Guo for CS 416</p>
      </div>
    </div>

    <div id="intro">
      <h2>Introduction</h2>
      <u1>
        <li class="font-size-lg mt-50">
          "With the housing market not performing as well as it once was, an investigation into trends with the economy and changes within the last 25 years since 1997 would provide some insight into the current state of the housing market."
        </li>
        <li class="font-size-lg mt-50">
          "An attempt to look into how the population for each state will be provided along with the GDP and household income of each state."
        </li>
        <li class="font-size-lg mt-50">
          "This will be attempted within an interactive slideshow which will detail each of the metrics above and provide context behind those changes."
        </li>
      </u1>
      <br>
      <div class="mt-30">
        <em>Data: https://fred.stlouisfed.org/</em>
      </div>
      <hr>
    </div>
    
    <div class="row">
      <div class="col-sm wrapable">
        <div style="text-align: center;">
          <h3>House Price Index (HPI) vs Time</h3>
          <div id="chart">
            <svg width="700" height="600"></svg>
          </div>
        </div>
      </div>
      <div class="col-sm">
        <div valign="top" class="wrapable right-panel wrapped">
          <nav style="display: inline;">
            <ul class="pagination pagination-sm">
              <li>
                <h4 style="margin-right: 10px;">Chart Navigation:</h4>
              </li>
              <li class="page-item disabled"><a class="page-link" href="./">&lt;</a></li>
              <li class="page-item active"><a class="page-link" href="./">1</a></li>
              <li class="page-item"><a class="page-link" href="./housing_income.html">2</a></li>
              <li class="page-item"><a class="page-link" href="./housing_population.html">3</a></li>
              <li class="page-item"><a class="page-link" href="./housing_gdp.html">4</a></li>
              <li class="page-item"><a class="page-link" href="./housing_income.html">&gt;</a></li>
            </ul>
          </nav>
          <hr>
          <div id='addtl-info'>
            <h3>Additional Information</h3>
            <h4 id="year">Year</h4>
            <table>
              <tr>
                <td class="stat-label">Region</td>
                <td id="region">-</td>
              </tr>
              <tr>
                <td class="stat-label">Division</td>
                <td id="division">-</td>
              </tr>
              <tr>
                <td class="stat-label">HPI</td>
                <td id="hpi">-</td>
              </tr>
              <tr>
                <td class="stat-label">Median Household Income</td>
                <td id="med-household-income">-</td>
              </tr>
              <tr>
                <td class="stat-label">GDP</td>
                <td id="gdp">-</td>
              </tr>
              <tr>
                <td class="stat-label">Population</td>
                <td id="population">-</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function init() {
      var data = await d3.csv("./data/us_avg_year.csv");

      console.log(data);
      console.log(d3.timeParse("%Y-%m-%d")(data[0].date));

      var svg = d3.select("svg")
        .append("g")
        .attr("transform", "translate(" + 50 + "," + 50 + ")");

      console.log(data[0].date.substring(0,4));

      var x = d3.scaleTime()
      .domain(d3.extent(data, function(d) { return d3.timeParse("%Y-%m-%d")(d.date); }))
      .range([ 0, 600 ]);
      svg.append("g")
      .attr("transform", "translate(0," + 500 + ")")
      .call(d3.axisBottom(x));

      var y = d3.scaleLinear()
      .domain([d3.min(data, function(d) { return d.hpi; }), d3.max(data, function(d) { return d.hpi; })])
      .range([ 500, 0 ]);
      svg.append("g")
      .call(d3.axisLeft(y));

      svg.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d3.timeParse("%Y-%m-%d")(d.date)) })
        .y(function(d) { return y(d.hpi) })
        );

      // const mouse_g = svg.append('g').classed('mouse', true).style('display', 'none');
      // mouse_g.append('rect').attr('width', 2).attr('x',-1).attr('height', 500).attr('fill', 'lightgray');
      // mouse_g.append('circle').attr('r', 3).attr("stroke", "steelblue");
      // mouse_g.append('text');

      // svg.on("mouseover", function(mouse) {
      //   mouse_g.style('display', 'block');
      // });

      // const [min_year, max_year] = d3.extent(data, d=>d.date.substring(0,4));

      // console.log(min_year, max_year);

      // console.log(data.find(d => d.date.substring(0,4) == min_year));

      // console.log(d3.pointer(mouse));

      // svg.on("mousemove", function(mouse) {
      //   const [x_cord,y_cord] = d3.pointer(mouse);
      //   const ratio = x_cord / 600;
      //   const current_year = min_year + Math.round(ratio * (max_year - min_year));
      //   const hpi = data.find(d => d.date.substring(0,4) == current_year.toString()).hpi;
      //   const hi = data.find(d => d.date.substring(0,4) == current_year.toString()).hi;
      //   const gdp = data.find(d => d.date.substring(0,4) == current_year.toString()).gdp;
      //   const pop = data.find(d => d.date.substring(0,4) == current_year.toString()).pop;
      //   mouse_g.attr('transform', `translate(${x(current_year)},${0})`);
      //   mouse_g.select('text').text(`year: ${current_year}, HPI: ${hpi}`)
      //     .attr('text-anchor', current_year < (min_year + max_year) / 2 ? "start" : "end");
      //   mouse_g.select('circle').attr('cy', y(hpi));
      // });
      // svg.on("mouseout", function(mouse) {
      //   mouse_g.style('display', 'none');
      // });

      // code from https://github.com/datavizdad/d3linechartseries/blob/main/Part3/scriptfinal.js
      const tooltip = d3.select("#chart").append("div").attr("class","tooltip");

      var tooltipParent = tooltip.node().parentElement;
      var matrix = this.getTransformToElement(tooltipParent).translate(+this.getAttribute("cx"),+this.getAttribute("cy"));

      const circle = svg.append("circle")
        .attr("r", 0)
        .attr("fill", "steelblue")
        .style("stroke", "white")
        .attr("opacity", .70)
        .style("pointer-events", "none");

      const listeningRect = svg.append("rect")
        .attr("width", 600)
        .attr("height", 500);

      svg.on("mousemove", function (event) {
        const [xCoord] = d3.pointer(event, this);
        const bisectDate = d3.bisector(d => d3.timeParse("%Y-%m-%d")(d.date)).left;
        const x0 = x.invert(xCoord);
        const i = bisectDate(data, x0, 1);
        const d0 = data[i - 1];
        const d1 = data[i];
        const d = x0 - d3.timeParse("%Y-%m-%d")(d0.date) > d3.timeParse("%Y-%m-%d")(d1.date) - x0 ? d1 : d0;
        const xPos = x(d3.timeParse("%Y-%m-%d")(d.date));
        const yPos = y(d.hpi);

        circle.attr("cx", xPos)
          .attr("cy", yPos);

        // Add transition for the circle radius

        circle.transition()
          .duration(50)
          .attr("r", 5);

        // add in  our tooltip

        tooltip
          .style("display", "block")
          .style("left", `${xPos}px`)
          .style("top", `${yPos}px`)
          .html(`<strong>Date:</strong> ${d3.timeParse("%Y-%m-%d")(d.date).toLocaleDateString()}<br><strong>House Price Index:</strong> ${d.hpi !== undefined ? d.hpi : 'N/A'}`)
      });

      svg.on("mouseleave", function () {
        circle.transition()
          .duration(50)
          .attr("r", 0);

        tooltip.style("display", "none");
      });

      // const bisect = d3.bisector(d => d.date).center;
      // function pointermoved(event) {
      //   const i = bisect(data, x.invert(d3.pointer(event)[0]));
      //   tooltip.style("display", null);
      //   tooltip.attr("transform", `translate(${x(data[i].date)},${y(data[i].hpi)})`);

      //   const path = tooltip.selectAll("path")
      //     .data([,])
      //     .join("path")
      //       .attr("fill", "white")
      //       .attr("stroke", "black");

      //   const text = tooltip.selectAll("text")
      //     .data([,])
      //     .join("text")
      //     .call(text => text
      //       .selectAll("tspan")
      //       .data([data[i].date, data[i].hpi])
      //       .join("tspan")
      //         .attr("x", 0)
      //         .attr("y", (_, i) => `${i * 1.1}em`)
      //         .attr("font-weight", (_, i) => i ? null : "bold")
      //         .text(d => d));

      //   size(text, path);
      // }

      // function pointerleft() {
      //   tooltip.style("display", "none");
      // }

      // // Wraps the text with a callout path of the correct size, as measured in the page.
      // function size(text, path) {
      //   const {x, y, width: w, height: h} = text.node().getBBox();
      //   text.attr("transform", `translate(${-w / 2},${15 - y})`);
      //   path.attr("d", `M${-w / 2 - 10},5H-5l5,-5l5,5H${w / 2 + 10}v${h + 20}h-${w + 20}z`);
      // }
    }
  </script>
</body>

</html>